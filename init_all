#!/usr/bin/env bash

source ./init_basic

set -euo pipefail

echo "initializing all components..."

amd64_install() {
    # nothing to do right now
    echo "no additional softwares for x86_64"
}

arch_main_install() {
    pacman ${pacman_args[*]} neovim jq

    pacman ${pacman_args[*]} keepassxc kclock kjournald khelpcenter pdfarranger krdc krfb \
        systemdgenie kcron flatpak-kcm sshfs kweather kcharselect plasma-workspace-wallpapers \
        bleachbit ttf-jetbrains-mono ttf-jetbrains-mono-nerd drkonqi vlc

    amd64_install

    sed -i 's/^#Color.*/Color/' "/etc/pacman.conf"

    # for timeshift scheduler. I'm commenting it out for now as for some reason snapshots created by
    # the scheduler is corrupt and it once broke my system
    systemctl enable --now cronie
}

install_flatpak() {
    case "$DISTRO_ID" in
    arch) pacman ${pacman_args[*]} flatpak ;;
    esac
}

flatpak_prompt() {
    response=
    if ! command -v flatpak &>/dev/null; then read -p 'install flatpak? [y/N]: ' response; fi
    if [[ $response == 'y' ]]; then
        install_flatpak
        echo 'please relogin in order for your apps to appear in menu'
    fi
}

flatpak_basic() {
    flatpak_prompt
    read -p 'install flatpak? [y/N]: ' response

    [[ "$response" != 'y' ]] && return

    flatpak install -y io.github.flattool.Warehouse com.github.tchx84.Flatseal \
        org.localsend.localsend_app org.freefilesync.FreeFileSync ca.desrt.dconf-editor \
        org.onlyoffice.desktopeditors com.usebottles.bottles com.obsproject.Studio

    # NOTE: installing both flatpak-kcm and flatseal seems redundant,
    # but currently you can't set global setting for apps in flatpak-kcm.
    # That seems flatseal is the way to go, but I like how flatpak-kcm
    # integrates well with the system-settings.
}

if ! command -v oh-my-posh &>/dev/null; then
    read -p 'do you want to install oh-my-posh (for shell customization)? (y/N)' answer

    if [[ $answer == y ]]; then
        curl -s https://ohmyposh.dev/install.sh | bash -s -- -d $CUSTOM_BIN
    fi
fi

case "$DISTRO_ID" in
termux)
    pkg install eza jq lazygit neovim oh-my-posh git-delta
    ;;

arch)
    arch_main_install
    flatpak_basic
    ;;

cachyos)
    arch_main_install
    flatpak_basic
    ;;

fedora)
    dnf copr enable atim/lazygit -y
    dnf install -y eza jq lazygit neovim git-delta keepassxc timeshift kalk kclock krecorder \
        kcron kweather qmmp

    read -p "do you want to uninstall some redundant apps? [y/N]" remren
    if [[ $remren == y ]]; then
        dnf remove -y dragon kcalc
    fi

    amd64_install
    ;;

ubuntu)
    apt install eza jq trash-cli neovim
    amd64_install

    # lazygit
    LAZYGIT_VERSION=$(curl -s "https://api.github.com/repos/jesseduffield/lazygit/releases/latest" |
        grep -Po '"tag_name": "v\K[^"]*')

    curl -Lo lazygit.tar.gz "https://github.com/jesseduffield/lazygit/releases/latest/download/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz"
    tar xf lazygit.tar.gz lazygit
    install lazygit $CUSTOM_BIN
    ;;

linuxmint) ;;

esac

echo "all components are successfully installed"
